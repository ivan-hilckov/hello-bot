# Simple Production Docker Compose for Hello Bot
# For development, use: docker compose -f docker-compose.dev.yml up

services:
  # Database Migration Service (runs before app startup)
  migration:
    image: ${BOT_IMAGE}
    container_name: ${PROJECT_NAME}_migration
    env_file: .env
    environment:
      DATABASE_URL: postgresql+asyncpg://${PROJECT_NAME}_user:${DB_PASSWORD}@postgres-shared:5432/${PROJECT_NAME}_db
    command: [ "alembic", "upgrade", "head" ]
    depends_on:
      - postgres-check
    networks:
      - shared_network
    profiles:
      - migration
      - production
    restart: "no" # Run once and exit

  # PostgreSQL Check Service (ensures shared DB is ready)
  postgres-check:
    image: postgres:15-alpine
    container_name: ${PROJECT_NAME}_db_check
    command: >
      sh -c "until pg_isready -h postgres-shared -p 5432 -U postgres; do
        echo 'Waiting for PostgreSQL...'; sleep 2;
      done && echo 'PostgreSQL ready!'"
    networks:
      - shared_network
    profiles:
      - migration
      - production
    restart: "no"

  # Telegram Bot Application (Production)
  bot:
    image: ${BOT_IMAGE}
    container_name: ${PROJECT_NAME}_app
    env_file: .env
    environment:
      # Database configuration
      DATABASE_URL: postgresql+asyncpg://${PROJECT_NAME}_user:${DB_PASSWORD}@postgres-shared:5432/${PROJECT_NAME}_db

      # Bot configuration
      BOT_TOKEN: ${BOT_TOKEN}

      # Application settings
      ENVIRONMENT: ${ENVIRONMENT:-production}
      DEBUG: ${DEBUG:-false}

      # Webhook configuration (optional)
      WEBHOOK_URL: ${WEBHOOK_URL:-}

      # Python optimizations
      PYTHONOPTIMIZE: "1"
      PYTHONDONTWRITEBYTECODE: "1"
      PYTHONUNBUFFERED: "1"
    ports:
      - "8000:8000"
    depends_on:
      postgres-check:
        condition: service_completed_successfully
      migration:
        condition: service_completed_successfully
    # Simple resource limits for bot
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
    restart: unless-stopped
    networks:
      - shared_network
    # Simple health check
    healthcheck:
      test: [ "CMD", "python", "-c", "from app.config import settings; exit(0 if settings.bot_token else 1)" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    profiles:
      - production

networks:
  shared_network:
    name: vps_shared_network
    external: true
